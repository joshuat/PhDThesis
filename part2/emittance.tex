\chapter{Time-Resolved Brightness Measurements}

Brightness is one of the best figure of merit for determining the quality of a charged particle beam.
The brightness of a beam represents the current density per unit solid angle and combines the beam charge with the focusability of the beam, which is known as the emittance.
Emittance determines the `focusability' of a beam which determines the minimum size of the probe for electron and ion microscopes and is equivalent to the coherence for synchrotrons, \glspl{xfel} and diffraction experiments.
Synchrotrons, \glspl{xfel} and diffraction experiments also have requirement on the beam charge required in order to perform measurements in suitable timescales which, for ultrafast experiments, can be measured in femtoseconds.

Time-resolved measurements of emittance and brightness can provide a powerful diagnostic for the improvement of charged particle beams.
Elucidation of temporal behaviour of brightness has the potential to permit better understanding of the processes involved in the creation and propagation of charged particle beam and thus could be a useful tool in improving these devices.
Time-resolved emittance measurements have been performed previously using a pulsed \gls{mcp}~\cite{yoshida_simple_2001}, with translating slits and a Faraday cup~\cite{anders_time-resolved_2003} and electro-optic shutters~\cite{bekefi_temporal_1987}, however all of these methods require many iterations of the experiment to build up the temporal profile.
Time-resolved emittance measurements have been used to study the behaviour of metal ion sources for implantation and fusion~\cite{anders_time-resolved_2003, yoshida_simple_2001} and to determine that velvet-backed cathodes in field-emission electron guns are superior to graphite backed ones~\cite{bekefi_temporal_1987}.

This chapter presents a simple and novel method of measuring time-resolved emittance that is applicable to a wide range of charged particle sources and has the potential to be performed with a single-shot measurement.
The brightness of a \gls{caeis} is important to all of it's potential applications and the time-resolution provided by the technique described in this chapter will be a useful tool to examine the behaviour of the source and hopefully provide avenues for improvement.

The method examined here for time-resolved emittance measurement is an adaption of the pepperpot method that achieves the time resolution through streaking.
Streaking of charged particle beams involves applying a changing electric field to the beam in order to move it across the detector.
The streaking technique has been used previously for a number of measurements and is central to the operation of streak cameras.
Streaking has been used to provide time-resolution to ultrafast diffraction experiments using an \gls{rf} deflecting cavity to $\sim$\unit[200]{fs} resolution\cite{li_note:_2010}.

With the potential to be performed in a single shot this technique could provide a number of interesting features to measurements in comparison with multi-shot measurements.
Single-shot measurement simple allow for measurement to be acquired quicker than through other methods which is particularly useful in experiments that require the exploration of multi-dimensional parameter spaces.
Time-resolved single-shot measurements also have the potential to reveal additional information on behaviours that may vary from shot-to-shot which would be obscured by multi-shot averaging.

This chapter examines time-resolved emittance measurements through the streaking of pepperpots; including the theory involved, various technical considerations, example measurements and implementation of this technique with the \gls{caeis} at the University of Melbourne.


{\color{red}When paper is done add citation here.}

\section{Brightness and Emittance}

A given ensemble of particles can be described by its density in six-dimensional phase space, $(x, p_x, y, p_x, z, p_z)$ where $(x, y, z)$ are the positions and $(p_x, p_y, p_z)$ are the momenta of each particle.
The extent of the beam in phase space is called the \emph{emittance}, $\epsilon$, of the beam.
Each Cartesian direction is examined separately, $(\epsilon_x, x, p_x)$, $(\epsilon_y, y, p_y)$ and $(\epsilon_z, z, p_z)$ where $z$ is the optic axis of the beam.

Typically the gradients of trajectories in $x$-$z$ and $y$-$z$ are measured rather than the momenta.
These gradients are referred to as the divergence and are defined as
\begin{equation}\label{equation:divergence}
x^\prime \equiv \frac{dx}{dz} = \frac{v_x}{v_z}.
\end{equation}
The space of $(x, x^\prime)$ is referred to as trace-space.
An example of the trace-space occupied by a beam is shown in Figure~\ref{figure:emittance_example}.
The \emph{emittance} can be defined as
\begin{equation}
\epsilon^x \equiv \frac{A^x}{\pi}
\end{equation}
where $A^x$ is the area occupied by the beam in trace space.

\begin{figure}
\center
\includegraphics{part2/Figs/EmittanceExample.pdf}
\caption{An example of the trace-space occupied by an expanding, collimated and shrinking beam. The dotted line indicates the area occupied by the beam, the emittance.}
\label{figure:emittance_example}
\end{figure}

The density, $\rho$, of a beam of $N$ particles in trace space can usually be described by a Gaussian:
\begin{equation}\label{trace_space_density}
\rho(x, x^\prime) = N exp\left[ \frac{-(\sigma_{22}x^2-2\sigma_{12}xx^\prime+\sigma_{11}x^{\prime2}}{2|\sigma|} \right]
\end{equation}
where $|\sigma|$ is the determinant of the symmetric beam matrix,
\begin{equation}
\sigma = \begin{pmatrix} \sigma_{11} & \sigma_{12} \\ \sigma_{21} & \sigma_{22} \end{pmatrix}.
\end{equation}
$\sigma_{11}$ is the standard deviation of $x$, $\sigma_{22}$ the standard deviation of $x^\prime$ and $\sigma_{12}=\sigma_{21}$ indicates the coupling between $x$ and $x^\prime$. The \emph{emittance} can also be defined as
\begin{equation}\label{eq:emittancewithdeterminant}
\epsilon^x \equiv \sqrt{|\sigma|} = \sqrt{\sigma_{11}\sigma_{22}-\sigma_{12}^2}
\end{equation}

The \emph{\gls{rms} emittance} is a more practical measure and is defined as
\begin{equation}\label{emittance}
\epsilon \equiv \sqrt{\langle x^2\rangle \langle x^{\prime 2}\rangle - \langle x x^\prime\rangle^2}.
\end{equation}

The emittance of a beam represents the `focusability' of the beam.
A low emittance beam can be focused to a smaller waist than a high emittance beam, in fact a beam with zero emittance could be focused to a point whereas any beam with non-zero emittance has a finite spot size, this is shown in Figure~\ref{figure:focusability}.
This makes emittance an important quantity to consider in almost all beam applications but is particularly important to charged beams due to complications produced by space-charge repulsion.

\begin{figure}
\center
\includegraphics{part2/Figs/EmittanceFocasability.pdf}
\caption{On the left is a particle beam with zero emittance, and thus can be focused to a beam waist of zero width. On the right is a beam with non-zero emittance and thus a non-zero beam waist. Below each figure are plots of the phase space at difference points in the beam where the dashed line is indicative of the phase-space area or emittance.}
\label{figure:focusability}
\end{figure}

The emittance of a beam is not the only factor that determines the quality of the beam.
Emittance could be made arbitrarily small through the use of collimating slits however the reduced particle could would reduce the usefulness of that beam for most applications.
A more comprehensive figure of merit is the number of particles with a given emittance, known as \emph{brightness}~\cite{reiser_theory_2008};
\begin{equation}
B = \frac{I}{8\pi^2\epsilon_x\epsilon_y},
\end{equation}
where $I$ is the current of the beam and $\epsilon_{x,y}$ is the emittance as described above.
Brightness provides a better metric of a beam's quality with the additional requirement of knowing the beam current.

When comparing the emittance and brightness of particle beams from different sources it is often useful to use the \emph{normalised} emittance and brightness
\begin{align}
\bar{\epsilon_x} = \beta\epsilon_x,\\
\bar{B} = \frac{I}{8\pi^2\bar{\epsilon_x}\bar{\epsilon_y}}
\end{align}
where $\beta=v/c\approx v_z/c$.


\subsection{Emittance with a CAEIS}
\label{section:excess_energy_emittance}

For a \gls{caes} the normalised \gls{rms} emittance at the source is given by~\cite{mcculloch_high-coherence_2013}
\begin{equation}\label{equation:excess_energy_emittance}
\epsilon_x = \sigma_x \sqrt{\frac{k_B T}{m c^2}}
\end{equation}
where $\sigma_x$ is the \gls{rms} beam radius, $k_B$ is Boltzmann's constant, $T$ is the temperature of the source, $m$ is the particle mass and $c$ is the speed of light.
Equation~\ref{equation:excess_energy_emittance} highlights one of the advantages of a \gls{caeis} as the low source temperature allows for low emittance bunches compared to the common thermionic sources.

The temperature of the \gls{caeis} source can be calculated from the wavelength of the ionisation lasers, $\lambda_{red}$ and $\lambda_{blue}$,
\begin{align}
 E_{red} &= \frac{hc}{\lambda_{red}} \\
 E_{blue}&= \frac{hc}{\lambda_{blue}},
\end{align}
where $h$ is Plank's constant.
We can define the total ionisation energy to be
\begin{align}
E_{total} = E_{red} + E_{blue}.
\end{align}
The ionisation energy for Rubidium 85, $E_I$ is \unit[4.18]{eV} so we can determine the excess energy of ionisation
\begin{equation}
E_{excess} = E_{total} - E_I
\end{equation}

The excess energy can be related to the temperatures of the ionised particles via
\begin{equation}\label{equation:excess_energy_temperature}
T = \frac{E_{excess}}{k_B}.
\end{equation}
Combining Equations \ref{equation:excess_energy_emittance} and \ref{equation:excess_energy_temperature} allows for the calculation of the expected emittance of bunches generated from the \gls{caeis} for above-threshold ionisation.
The emittance of bunches generated from below-threshold pathways, such as Rydberg-excitation with field-ionisation, cannot be calculated using Equation~\ref{equation:excess_energy_emittance}.

\section{Measurement}

Directly calculating the emittance of an ensemble with Equation~\ref{emittance} requires full knowledge of the position and momenta of the particles which is difficult as beam monitors tend to only measure the transverse positions of particles.
There are a number of methods to practically calculate the emittance of a particle beam, namely pepperpots, the multiple profile method methods and the quadrupole method.
In the \gls{caeis} the quadrupole method is not practical as the lenses in the system are not well characterised and multi-profile measurements are tedious due to the manual z-translation of the detector and bellows.
The pepperpot method however is eminently achievable with this system although the details of the geometry are not ideal with this iteration of a \gls{caeis}.

\subsection{Pepperpots}

The pepperpot method uses a beam mask, consisting of an array of small holes, to separate the beam into a number of `beamlets' which are then propagated and detected downstream.
By examining the size of the beamlets the divergence of the beam can be estimated and thus the emittance of the beam can be calculated.
Ideally the extent of the array should be larger than the size of the beam and the holes are as small as is practical while maintaining sufficient flux and ensuring the spots on the detector do not overlap.
The name refers to the similarity of the simplest beam mask to the perforated lid of a container for pepper.

A useful derivation of this technique is presented in Ref.~\cite{zhang_emittance_1996} with the one dimensional result:

\begin{dmath}\label{equation:pepperpot}
\epsilon_x^2 = \left\langle x^2\right\rangle \left\langle x^{\prime2}\right\rangle - \left\langle xx^\prime\right\rangle^2\allowbreak
\approx \frac{1}{N^2} \left\{\left[\sum_{j=1}^p{n_j\left(x_{sj}-\bar{x}\right)^2}\right] \left[ \sum_{j=1}^p{\left[n_j\sigma_{x_j^\prime}^2 + n_j\left(\bar{x_j^\prime}-\bar{x^\prime}\right)^2\right]}\right] - \left[ \sum_{j=1}^p{n_jx_{sj}\bar{x_j^\prime}-N\bar{x}\bar{x^\prime}}\right]^2\right\}
\end{dmath}
where;
\begin{itemize}
    \item $N$ is the total number of particles after the beam mask,
    \item $p$ is the total number of holes in the $x$ direction,
    \item $n_j$ is the number of particles passing through the $j$-th hole and hitting the detector,
    \item $x_{sj}$ is position of the $j$-th hole,
    \item $\bar{x}$ is the mean position of the holes,
    \item $\sigma_{x_j^\prime}$ is the \gls{rms} divergence of the $j$-th beamlet,
    \item $\bar{x_j^\prime}$ is the mean divergence of the $j$-th beamlet, and
    \item $\bar{x^\prime}$ is the mean divergence of all beamlets.
\end{itemize}

An example pepperpot mask and detected beamlets are shown in Figure~\ref{figure:pepperpot_example}.
This equation can be implemented by appropriately rotating the detected beamlets and then performing row and column sums of the pixels followed by application of Equation~\ref{equation:pepperpot} for $x$ and $y$.

\begin{figure}
    \centering
    \begin{subfigure}{0.49\linewidth}
    \centering
    \includegraphics[width=\linewidth]{part2/Figs/example_pepperpot_mask.jpg}
    \caption{}
    \label{figure:pepperpot_mask}
    \end{subfigure}
    \begin{subfigure}{0.49\linewidth}
    \centering
    \includegraphics[width=\linewidth]{part2/Figs/example_pepperpot_detector_linear.jpeg}
    % 486.971 pepperpot from 2017.06.06
    \caption{}
    \label{figure:pepperpot_image}
    \end{subfigure}
    
    \begin{subfigure}{0.49\linewidth}
    \centering
    \includegraphics[width=\linewidth]{part2/Figs/example_pepperpot_1d.jpg}
    \caption{}
    \label{figure:1d_pepperpot}
    \end{subfigure}
    \begin{subfigure}{0.49\linewidth}
    \centering
    \includegraphics[width=\linewidth]{part2/Figs/example_streaked_pepperpot.png}
    \caption{}
    \label{figure:streaked_1d_pepperpot}
    \end{subfigure}
    % Manual labels.....
    \caption{(a) a pepperpot mask cut into a thing copper disk and, (b), the corresponding set of beamlets on the detector. (c) a one-dimensional pepperpot mask (held in place by a copper ring) and the corresponding streaked set of beamlets on the detector, (d). The beam images are log scaled.}
    \label{figure:pepperpot_example}
\end{figure}

\subsubsection{Temporal Resolution with Streaking}
A one-dimensional pepperpots can consist of a line of apertures and provides a prime target for a streak measurements.
In this case streaking is performed with a time varying electric field which deflects the charged particles across the detector, providing time-resolution.
For a pulsed charged particle source, such as the \gls{caeis}, the streak can be performed over the duration of the bunch or over a portion of the bunch if higher resolution is required.
There are some considerations for how fast an electric field can be swept, which will not be examined in detail here, so extremely short bunches will require more complicated systems, such as a \gls{rf} cavity or photoactivated switching, to provide the appropriate timing and electric field temporal-gradient~\cite{alesini_rf_2006,kassier_compact_2010}.
An example of a streaked pepperpot measurement is shown in Figure~\ref{figure:streaked_1d_pepperpot}.

% \subsection{Multi-profile Method}

% If a beam can be described by $\sigma^0$ at $z_0$ and by $\sigma^1$ at $z_1$ then the transformation matrix, $\mathbf{R}_{12}$ from $z_0$ to $z_1$ is
% \begin{equation}
% \mathbf{R} = \begin{pmatrix} R_{11} & R_{12} \\ R_{21} & R_{22} \end{pmatrix}
% \end{equation}
% and
% \begin{equation}
% \sigma^1 = \mathbf{R}\sigma^0\mathbf{R}^T
% \end{equation}
% where $\mathbf{R}^T$ is the transpose of $\mathbf{R}$.
% The combined transfer matrix for a series of $z$ positions is simply the product of the individual transfer matrices.

% We can write:
% \begin{equation}\label{equation:multiprofile}
% \sigma_{11}^1 = R_{11}^2\sigma_{11}^0 + 2R_{11}R_{12}\sigma_{12}^0 + R_{12}^2\sigma_{22}^0
% \end{equation}

% Typical detectors are only able to measure the standard deviation of $x$, $\sigma_{11}$.
% With at least three measurements and known transfer matrices the other elements of $\sigma$ can be determined.
% With more than three measurements uncertainty can be reduced.

% The transfer matrix for simple propagation over a distance $L$ is
% \begin{equation}
% \mathbf{R}_L = \begin{pmatrix}1 & L \\ 0 & 1\end{pmatrix}
% \end{equation}
% and then Equation~\ref{equation:multiprofile} becomes
% \begin{equation}
% \sigma_{11}^1 = \sigma_{11}^0 + 2L \sigma_{12}^0 + L_1^2\sigma_{22}^0.
% \end{equation}

% \begin{figure}
% \center
% \includegraphics{part2/Figs/Multi-ProfileEmittance.pdf}
% \caption{An example of a multi-profile emittance measurement conducted on an expanding beam travelling from left to right (or a shrinking beam travelling right to left).}
% \label{figure:multiprofileexample}
% \end{figure}

% With an initial beam, $\sigma_0$, measured at $z_1, z_2$ and $z_3$ as shown in Figure~\ref{figure:multiprofileexample} then $\sigma_{11}^1$, $\sigma_{11}^2$, and $\sigma_{11}^3$ are know and we can write 
% \begin{align}
% \sigma_{11}^1 &= \sigma_{11}^0 +2L_{01}\sigma_{12}^0 + L_{01}^2\sigma_{22}^0 \notag\\
% \sigma_{11}^2&= \sigma_{11}^0+2(L_{01}+L_{12})\sigma_{12}^0 + (L_{01}+L_{12})^2\sigma_{22}^0 \notag\\
% \sigma_{11}^3&= \sigma_{11}^0+2(L_{01}+L_{12}+L_{23})\sigma_{12}^0 + (L_{01}+L_{12}+L_{23})^2\sigma_{22}^0 \label{eq:multiprofilesolution}
% \end{align}

% Which can easily be solved for $\sigma_0$ thus allowing the calculation of the emittance with Equation~\ref{eq:emittancewithdeterminant}.

% This method is feasible with the \gls{caeis} at the University of Melbourne but labourious due to the manual operation of the bellows the detector is attached to.

% \subsection{Quadrupole Method}

% The quadrupole method is similar to the multi-profile method but requires only a single location to measure the beam width and a well characterised variable lens such as a quadrupole lens.
% A quadrupole lens with a magnetic field gradient of $G$ has the transfer matrix in the focusing plane of
% \begin{equation}
% \mathbf{R}_f = \begin{pmatrix} \cos kl & (1/k)\sin kl\\
% -k\sin kl & cos kl\end{pmatrix},
% \end{equation}
% where $l$ is the effective length of the quadrupole, $k^2=G/B\rho$ is the quadrupole strength and $B\rho$ is the magnetic rigidity of the particles in the assumed central trajectory.
% The matrix in the defocusing plane is
% \begin{equation}
% \mathbf{R}_d = \begin{pmatrix} \cosh kl & (1/k) \sin kl\\
% k \sinh kl & \cosh kl \end{pmatrix}
% \end{equation}

% A beam measured a distance $L$ away from the quadrupole will have undergone the transformation $\mathbf{R}=\mathbf{R}_L\mathbf{R}_f$ on one axis and $\mathbf{R}=\mathbf{R}_L\mathbf{R}_d$ on the other.
% The symmetric beam matrix for the beam before the lens can then be determined from a series of beam profile measurements with different focusing strengths.
% The main advantage of this measurement is that is only requires a single beam monitor location.

% Due to the ad hoc nature of the magnetic lenses used in the \gls{caes} this method is not practical without a thorough characterisation of the lenses, especially in comparison with the ease of the alternative methods.

\section{Experimental Setup}

A number of modifications were made to the \gls{caeis} to prepare it for the streaked emittance measurements and there were a number of restrictions on various parameters due to the precise setup of the apparatus.
The \gls{caeis} was operated in electron mode for these measurements due to the available magnetic optics and the larger emittance expected from electrons as the source temperature is higher for electrons, a minimum temperature of approximately \unit[10]{K} for electrons and \unit[100]{$\muup K$} for ions~\cite{saliba_spatial_2012}.
Using electrons also allows some control of the bunch emittance as the excess energy can be controlled with the blue ionisation laser wavelength, with ions the change in emittance would be negligible.

See Chapter~\ref{chapter:setup} for a more detailed description of the \gls{caeis} and Figure~\ref{figure:emittance_schematic} for a schematic of the setup used for the measurements in this chapter.

\begin{figure}
\center
\includegraphics{part2/Figs/EmittanceApparatusSchematic.pdf}
\caption{A schematic of the experimental apparatus with relevant dimensions. The blue region indicates the electron beam envelope. Note that components are not necessarily orientate realistically in this schematic (particularly the deflectors).}
\label{figure:emittance_schematic}
\end{figure}

\subsection{Beam Optics}
The quadrupole electron optics discussed in Section \ref{section:quadrupole} were use to reduce the astigmatism present in the electron beam as discussed in the aforementioned section.
The two-dimensional pepperpot provide another avenue to monitor the astigmatism of the beam as with an astigmatic beam the spacing of the beamlets on the detector are not the same along each axis as shown in Figure~\ref{figure:astigmatic_pepperpot}.
When focussing was required the Einzel lens was used.

\begin{figure}
    \center
    \includegraphics[width=0.5\linewidth]{part2/Figs/example_astigmatic_pepperpot.jpeg}
    \caption{An example of a pepperpot without the beam correction from the quadrupole lens. It is readily apparent that spacing of the beamlets is not the same for the $x$ and $y$ axes. This image is log scaled.}
    \label{figure:astigmatic_pepperpot}
    % From 2017.06.01
\end{figure}

A number of permanent magnets were used to steer the beam through the various apertures and onto the detector and care was taken to attempt to keep the beam on the central axis of the apparatus.
This was achieved by manually adjusting the positions of the magnets, which were mounted on posts external to the vacuum system, to ensure that the beam was passing through the apertures in the system and by scanning the Einzel lens to verify that the beam was passing through its centre.
Due to the unstable nature of the apparatus these magnets needed to be adjusted on a day-to-day basis to maintain the beam path.

The main limiting factor to pepperpot emittance measurements using the \gls{caes} was electron flux through the pepperpot masks.
Flux through the pepperpot masks was maximised by using the Einzel lens to focus the beam to the approximate size of the pepperpots in the pepperpot plane, thus maximising the flux through the apertures.
The Einzel lens voltage required for this was approximately \unit[4.8][kV] and varied slightly beam emittance, i.e.. high emittance beams result in a larger beam size and thus required adjusting the Einzel lens voltage by \unit[100]{V} or so.

\subsection{Beam Energy}
In many emittance measurements the beam energy would not be a free parameter as it will be used as a diagnostic for a specific system or scenario, however in this experiment we are able to vary the energy of our beam from a few hundred eV to around \unit[10]{keV}.
There are a number of considerations in determining the optimal beam energy to use for pepperpot measurements such as measurement resolution, beam current and beam stability.

The resolution of a pepperpot measurement is greater when the size of the beamlets on the detector is larger and, as shown in Equation~\ref{equation:divergence} the divergence is greater for slower beams.
Unfortunately the slower the beam the more fragile the alignment of the beam becomes.
While attempting to align a \unit[500][eV] beam through it system it was impossible to position the steering magnets such that an unobstructed beam made it through the system to the detector.

A relatively high energy beam of \unit[8]{keV} was used as this provided a robust beam alignment that was resistant to the transient changes in the magnetic environment while providing sufficient measurement resolution.

\subsection{Bellows}

The bellows provide an additional mechanism to control the resolution of the measurement by adjusting the propagation distance of the pepperpot beamlets and thus their size on the detector.
As this parameter is also adjustable with the strength of the Einzel lens the bellows were placed approximately halfway between the minimum and maximum position where the beam alignment was still well behaved.

{\color{red}Add photo of bellows}

\subsection{Streaking}
The streaking was performed using a pair of deflectors located after the pepperpot sample and orientated such that the one-dimensional pepperpots could be streaked across the detector.
For these measurements one deflector was grounded and the other given a time-varying voltage which was supplied in one of two ways:
\begin{itemize}
\item A fast ramp using a bipolar push-pull solid-state switch with a fixed transition time of \unit[10]{ns} and
\item A slower ramp using an amplified signal generator with a minimum transition of approximately \unit[10]{$\muup$s}.
\end{itemize}
An example of the voltage ramps is shown in Figure~\ref{figure:deflector_voltages}. The slow ramp was done by amplifying the output of signal generator\footnote{Rigol DG4162, able to operate up to \unit[160]{MHz}} which is highly configurable and thus capable of a wide range of pulse lengths, limited by the speed of the amplifier to a transition time approximately \unit[10]{$\muup$s} in duration as shown in Figure~\ref{figure:deflector_voltages}.
More detail on the design of the streaking electronics can be found in Reference~{\color{red}(Cite Rory's thesis)}.

\begin{figure}
    \center
    \input{part2/Figs/DeflectorVoltages.pgf}
    \caption{The voltages applied to the deflectors for the `slow' (left) and `fast' (right) streak modes. The zero on the time axis refers to the start of the electron bunches as shown in Figure~\ref{figure:streaks}.}
    \label{figure:deflector_voltages}
    % Code and data located in 2017.07.25, plot2error.py
\end{figure}

Synchronisation with the experimental cycle was easily achieved using triggers from the pulse blaster, see Section~\ref{section:pulse_blaster}, and, while the pulse blaster did not have sufficient temporal resolution to correctly trigger the fast ramp, adjusting cable lengths for the trigger signal by a couple of meters provided an adequate delay.

An interesting effect that limited the potential length of the usable portion of fast streaks was `ringing' in the signal, this is shown in Figure~\ref{figure:ringing}.
Due to the ringing the range of the usable voltage sweep is somewhat truncated as any bunch with a duration longer than the sweep time will oscillate about the end point of the streak.
Fortunately the majority of the streak is usable and bunches with durations shorted than the voltage sweep time are not affected.

\begin{figure}
    \center
    \input{part2/Figs/VoltagesRinging.pgf}
    \caption{An example of ringing in the fast deflector voltage sweep. On the left is the Voltage on the detector from the start of the electron bunch, notice the slow damping oscillation after the fast \unit[10]{ns} sweep. On the right is an example of a streaked emittance measurement for a relatively long bunch length, notice the oscillations corresponding to the `ringing' present in the deflector voltage located on the right side of the figure.}
    \label{figure:ringing}
    % Fast streak from 2017.06.11 Set 12, code in 2017.07.25, plot2.py
\end{figure}

\subsubsection{Deflectors}

{\color{red}Figure showing deflectors, photo + cross section. Talk to Andy.}


\subsubsection{Calibration}
Calibration of the streak timing to the streak image was achieved with a calibration image, the voltage profile of the deflector during the streaking and assuming the streak position-time relation was linear.
The calibration image was taken by averaging a number of images with static deflector voltages at the maximum and minimum deflector positions in order to determine the pixel-voltage gradient, $\frac{dpixel}{dV}$.
The averaging of images at the two deflector positions was not required but is convenient for analysis.
Any transformations applied to the streaked pepperpot images, such as rotation and deskewing, needed to be applied to the calibration image before measuring $dpixel$.
An example calibration image is shown in Figure~\ref{figure:example_calibration}.
The deflector voltage profile was measured by a \unit[1]{GHz} oscilloscope\footnote{Tektronix DPO4104B-L Digital Phosphor Oscilloscope} with a probe attached to the vacuum feedthrough in order to minimise lag when comparing the deflector voltage to other signals, such as timing triggers.
The voltage gradient, $\frac{dV}{dt}$, was measured by a linear fit to the deflector voltage profile.
It was then simple to calculate the  deflection gradient for the image
\begin{equation}
\frac{dpixel}{dt} = \frac{dpixel}{dV} \frac{dV}{dt}.
\end{equation}

Determining the time during the voltage sweep that corresponds to the start of the streak was more difficult but could often be achieve by examining features that indicated the end of the streak such as that shown in Figure~\ref{figure:streaked_1d_pepperpot}.

\begin{figure}
    \center
    \includegraphics[width=0.5\linewidth]{part2/Figs/example_calibration.jpeg}
    \caption{An example of an image used to calibration the timing of the streaked pepperpots.}
    % Set 9 2017.06.11
    \label{figure:example_calibration}
\end{figure}

\subsection{Pepperpots}
There were a number of iterations on the precise configuration of the one- and two-dimensional pepperpots used in these experiments.
There are a number of considerations when designing pepperpot masks;
\begin{itemize}
    \item{\emph{Aperture size:} Smaller apertures provide a better resolution to the emittance measurement but reduce the signal as fewer particles pass through the hole.
    Aperture size affects the size of the beamlets on the detector, which impacts the overlap of beamlets on the detector, as the beamlets are a convolution of the aperture and the beam divergence. Smaller apertures also allow for a smaller aperture spacing as when the aperture diameter and aperture spacing are similar the pepperpot can become fragile.}
    \item{\emph{Aperture spacing:} Aperture spacing, also known as pitch, determines how well the full beam is sampled.
    Smaller pitch allows for better sampling of the full beam however pitch should be large enough that the beamlet overlap on the detector is manageable.
    If the pitch is too small then the pepperpot can also become fragile.}
    \item{\emph{Extent:} Ideally a the total extend of the pepperpot should be much larger than the largest beam for a particular apparatus.
    Unfortunately, due to the mounting arrangement of the Melbourne \gls{caeis}, the size of samples was limited to \unit[3]{mm} diameter and only a \unit[2]{mm} diameter portion of the sample was accessible to the beam. A view of the sample holder without the `lid' is shown in Figure~\ref{figure:sample_holder_pepperpots}.}
\end{itemize}

A number of restrictions aided the selection of parameters for the pepperpots used, the maximum pepperpot extent and need to focus the beam to the pepperpot size to maximise flux dictated the approximate size of the beamlets on the detector and thus the lowest feasibly pitch in order to minimise the overlap of beamlets on the detector.
The pepperpots were cut\footnote{The pepperpots were cut using a Oxford Laser Systems Alpha 532 laser micromachining system.} from \unit[25]{$\muup$ m} thick copper pinholes\footnote{Gilder Grids GA50-C3, \unit[50]{$\muup$ m} aperture.} with \unit[50]{$\muup$ m} diameter holes cut in the centre.
The central pinholes were used as the central aperture for the pepperpot arrays and since \unit[50]{$\muup$ m} apertures provide adequate flux the rest of the apertures were also cut to the same diameter to simplify analysis while providing acceptable measurement resolution.
A pitch of \unit[200]{$\muup$ m} was chosen to provide acceptable sampling of the beam while minimising the overlap of beamlets on the detector.
Given the \unit[2]{mm} diameter available this pitch allowed for one dimensional pepperpots with 7 apertures and two dimensional pepperpots with 7$\times$7 apertures.
The pepperpots used are shown in Figures~\ref{figure:pepperpot_mask} and \ref{figure:1d_pepperpot}.

\begin{figure}
    \center
    \includegraphics[width=0.49\linewidth]{part2/Figs/sample_holder.jpg}
    \caption{One of two sample holders that are used to load up to eight samples into the vacuum system. Clockwise from the top: five \unit[50]{$\muup$m} apertures with \unit[300]{$\muup$m} pitch, 7 by 7 pepperpot of \unit[50]{$\muup$m} apertures with \unit[200]{$\muup$m} pitch, 5 by 5 pepperpot of \unit[50]{$\muup$m} apertures with \unit[300]{$\muup$m} pitch, thin gold sample. Each sample is \unit[3]{mm} in diameter. A `lid' with appropriate apertures is placed over the samples to hold them in place.}
    \label{figure:sample_holder_pepperpots}
\end{figure}

\subsection{Laser Parameters}
Two of the lasers essential to the functioning are the `excitation' and `ionisation' lasers, see Section~\ref{section:two_stage_ionisation}, a CW red and pulsed blue laser respectively.
These lasers have a number of parameters that affect the emittance measurements.

\subsubsection{Excitation Laser}
The excitation laser was a \unit[780]{nm} laser, frequency locked to the Rb85 D2 F=3 to F=4 transition, which excites ground state atoms in the \gls{mot} to prepare the atoms for ionisation.
The spatial profile of this laser is highly controllable with a \gls{slm} allowing for arbitrary profiles to be mapped to the electron or ion bunch~\cite{mcculloch_arbitrarily_2011}.
The highest flux is possible by simply saturating the \gls{mot} however control over the electron beam profile and size is usually desirable.
One commonly used and simple distribution is a flat-top distribution as it can provide even electron intensity across the sample under examination however electron beams generated from electrons with high excess energy are unable to maintain the distribution, see Figure~\ref{figure:flat_top}.

\begin{figure}
    \center
    \input{part2/Figs/flattops_emittance.pgf}
    \caption{Unobstructed, unfocused electron beams generated with a flat-top profile on the excitation laser with varying ionisation laser wavelengths, and thus excess energies. The excess energy is listed above each beam profile. Below each profile is a trace of the central row of pixels (indicated by the dashed white line). The dotted lines on the lower figures indicate the profiles of the first and last profile for comparison.}
    \label{figure:flat_top}
    % Data and code at 2017.05.09
\end{figure}

If the electron beam has a simple, non-uniform spatial distribution, such as a Gaussian, then the specifics of the beam profile can be extrapolated from the pepperpot images allowing for further metrics to be calculated such as beam size and total electron count.
An example is shown in Figure~\ref{figure:pepperpot_profile}, the rows and columns of the pepperpot image can be summed to generate a one-dimensional set of beamlets.
From the amplitude and standard deviation of each beamlet the total number of electrons in each beamlet can be calculated and this corresponds to the number of electrons that passed through the corresponding apertures.
The apertures sample the full beam and a Gaussian (or other known beam profile) can be fitted to the beamlet electron counts to estimate the full beam profile and thus the beam size and full beam electron count can be determined.

\begin{figure}
    \center
    \input{part2/Figs/beam_size.pgf}
    \caption{On the left is a pepperpot image from a below-threshold low-emittance bunch (blue is \unit[486.9]{nm}). In the centre is a column sum of the pixels in the first image for which the amplitude and standard deviation are calculated for each of the seven peaks. In the right image the black line indicates the shape of the pepperpot in one-dimension, the blue crosses indicate the total number of electrons in each of the seven, column-summed, beamlets and the red dotted line indicates a Gaussian fitted to the beamlet electron counts and represents the full profile of the electron bunch incident on the pepperpots.}
    \label{figure:pepperpot_profile}
    % Data and code at 2017.06.06
\end{figure}

\subsubsection{Ionisation Laser}
The ionisation laser was a \unit[457-493]{nm}, \unit[10]{ns} pulse laser\footnote{Sirah dye laser system CSTR-D-3000.} which ionises the atoms excited by the red excitation laser.
The wavelength can be tuned to select various ionisation pathways such as above-threshold ionisation or field ionisation.
The pathway selected affects the duration of the bunch produced, above threshold ionisation results in short bunches with durations the same as the duration of the ionisation laser and below threshold ionisation can result in much longer bunches with durations of \unit[10s]{$\muup$ s} due to electrons tunneling out after the end of the ionisation pulse.

Another useful impact of the ionisation lasers wavelength is on the excess energy of the electrons and thus the emittance of the electron bunches.
This is discussed in Sections~\ref{section:excess_energy} and \ref{section:excess_energy_emittance}.
Equation~\ref{equation:excess_energy_emittance} gives a useful comparison and allows for verification of the accuracy of the emittance measurements.

\section{Simulations}

Due to the experimental constraints involving the low beam flux, pepperpot mask size limitations and lens aberations it was not possible to engineer an idea setup of beam and pepperpot parameters.
The non-ideal experimental parameters cause some distortions to the emittance measurements so simulations were performed to explore the effects and verify the validity of the corrections.
These simulation also proved to be a useful confirmation of the analysis procedure used on the experimental data.

The simulations were performed by a simple homemade particle tracker, able to operate in one- and two-dimensions, create arbirary bunch profiles with arbitrary emittances, propagate bunches and apply arbirary masks to the bunch.

For these simulations a Gaussian bunch profile was used and the emittance of the bunch was set to a range of values similar to those achieveable with the actual apparatus.
The path of the bunch was designed to replicate that of the \gls{caeis} by propagating the bunch to a `lens', then to a pepperpot mask and finally to a `detector'.
The `lens' was implemented by applying a radially dependent velocity change to the particles in order to focus the beam such that the beam size was approximately the same as the size of the pepperpot mask, approximately \unit[2]{mm}.

\subsection{Pepperpot Aperture Size}\label{section:pepperpot_simulation}

The first set of simulations investigated the effects of aperture size on the emittance measurement.
The procedure outline in Reference~\cite{zhang_emittance_1996}, which formed the foundation of the analysis used here, assumes that the size of the apertures used is neglible compared to the divergence of the particles.
Due the low emittance of the CAEIS and the low electron flux it is not feasible to use pepperpots with neglibly small holes so it is necessary to understand and correct for large pepperpot apertures.

The profile of a beamlet on the detector is a convolution of the aperture profile and the beamlet profile from an infinitesimally small aperture.
Thus, when the aperture size is large compared to the effects of the beam divergence, it will be difficult to determine the divergence whereas if the divergence affect is similar or large compared to the aperture size then the divergence will be easier to determine.
This results in an overestimation of beam divergence when the divergence and aperture size are similar and a minimum measureable divergence, and thus emittance, if the divergence is much smaller than the aperture size.
An example of a resolution limit for this experiment is shown in Figure~\ref{figure:wavelength_sim}.

The correction for finite apertures, where the aperture is not too large compared to the effect of the divergence, is to deconvolve the aperture size from the beamlet profile which is most easily implemented by fitting the width of a Gaussian convolved with the aperture size to the known beamlet size, taking magnification into account.
Reapplying the magnification to the result of the fit supplies the profile of beamlets had the apertures been infinitesimally small.

The results of the analysis of a simulations that varies the size of the apertures is shown in Figure~\ref{figure:aperture_size_sim}, the improvement in the accuracy of the analysis when the aperture size correction is applied is evident.

\begin{figure}
\begin{subfigure}[b]{\textwidth}
    \center
    \input{part2/Figs/wavelength_sweep_sim.pgf}
    \caption{The results of a simulation with a pepperpot mask with \unit[50]{$\muup$m} diameter apertures with an extent much larger than the beam size. The blue line is the result of analysis of the simulated data without the aperture size correction and the green line indicates the analysis results with the aperture size correction. The resolution limit of the mask is apparent with excess energies less than \unit[10]{meV}.}
    \label{figure:wavelength_sim}
    % Data and code located in Code/Electrons/Simulation/1D Simulation SimScript1D.py - Wavelength Sweep
\end{subfigure}

\begin{subfigure}[b]{\textwidth}
    \center
    \input{part2/Figs/aperture_size_sim.pgf}
    \caption{The results of a simulation that varies the size of the apertures used in the pepperpot mask. The blue line indicates the results of analysis without the correction for aperture size and the green line indicates the results with the correction. The dotted black line is the true emittance of the bunch being simulated.}
    \label{figure:aperture_size_sim}
    % Data and code located in Code/Electrons/Simulation/1D Simulation SimScript1D.py
\end{subfigure}
    \caption{}
\end{figure}

\subsection{Beamlet Overlap}
Once again, due to the experimental constraints it was difficult to produce ideal pepperpot measurements with one of the issues being the overlap of beamlets.
Most pepperpot analysis procedures assume that the beamlets are completely separated which was difficult to achieve with this apparatus while providing sufficient flux for streaked measurements and enough sampling of the beam to allow for estimation of the full-beam profile.
A naive analysis of overlapped beamlets might just analyse the potion of the beamlet between the troughs in the signal, however this results in an underestimate of the beamlet size due to the part underneath the neigbouring beamlets.
A more sophisticated approach is to determine the portion of the beams that are overlapped in order to correctly determine the width.
The method used here is to fit the sum of N Gaussians, where N is the number of beamlets, to the data.


\subsection{Pepperpot Extent and Beam Coverage}
The third correction that was made was to take into account the proportion of the beam that was covered by the pepperpot extent.
A pepperpot mask that has an extent smaller than the size of the beam is effectively aperturing the beam and an apertures reduce the emittance of a beam.
Thus, attempting to measure the emittance with a pepperpot that has an extent smaller the the size of the beam will result in an underestimation of the emittance proportional to coverage of the beam.

For a Gaussian-profile beam the correction takes is performed by dividing the calculated emittance by the weighted proportion of the beam covered by the pepperpot mask.



\section{Results}
In order to demonstrate the feasibility of time-resolved emittance measurement via the streaking of pepperpot measurements a number of measurements have been made including a comparison of two dimensional pepperpot emittance measurements with theory and slow and fast streaks used to determine the time-resolved brightness of electron bunches produced by the \gls{caes}.

\subsection{Analysis}
The analysis procedure developed was based on the theory described in Reference~\ref{zhang_emittance_1996} and Equation~\ref{equation:pepperpot}.
In order to determine the emittance from a one dimensional pepperpot measurement a number of parameters are required:
\begin{itemize}
    \item Size of pepperpot apertures
    \item Position of pepperpot apertures
    \item Size of beamlets on the detector
    \item Position of beamlets on the detector
    \item Total number of electrons (or camera counts) for each beamlet
\end{itemize}
The pepperpot parameters are known from the fabrication and the beamlet parameters can be determined from appropriately prepared two dimensional pepperpot and streaked pepperpot measurements.

The analysis procedure is roughly as follows:
\begin{enumerate}
    \item Acquire images from camera
    \item Register images (see Section~\ref{section:emittance_registration})
    \item Average registered images
    \item Rotate image so dominant features are aligned with the pixel rows
    \item Deskew image so features along the second axis aligned with the columns
    \begin{itemize}
        \item For two dimensional pepperpots sum the rows and columns individually to produce two one-dimensional sets of beamlets
        \item For streaked emittance measurements examine each column of pixels independently to produce a number of one-dimensional sets of beamlets.
    \end{itemize}
    \item For each beamlet set use peak finding algorithms to find the location of each beamlet peak
    \item Separate each beamlet set into individual beamlets
    \item Determine the amplitude, mean position and \gls{rms} width of each beamlet
    \item Transform the position and width measurements from pixel measurement to real measurements using the camera calibration
    \item Use Equation~\ref{equation:pepperpot} to determine the emittance
\end{enumerate}

Care has been taken to ensure that the full beam profile is Gaussian and this allows for the beamlet and pepperpot parameters to be used to fit to the full beam profile allowing for calculation of the full beam width and charge for each beamlet set.

\subsection{Calibrations}
A number of experimental parameters require calibration and the procedures for doing so are briefly outlined here.

\subsubsection{Detector-Camera Calibration}
The detector for the \gls{caeis} consists of a phosphor-coupled \gls{mcp} observed with a \gls{ccd} camera.
In order to relate distance in the images, measured in pixels, to distances on the phosphor screen, measured in meters, it is necessary to calibrate the camera.
This is easily achieved by placing a reliable ruler alongside the phosphor screen and taking an image which the number of pixels corresponding to a distance on the ruler, and thus the phosphor screen, to be determined.
The calibration was found to be \unit[24.5]{pixels per mm}.

\subsubsection{Electron-\gls{mcp}-Camera Calibration}
The number of camera counts generated by a single electron is another required calibration.
This is achieved by focusing a beam on to the Faraday cup that can be inserted into the beamline and measuring the number of electrons per bunch followed by removing the cup, unfocusing the beam and recording an image.
The total number of counts on the image can then be compared to the known number of electrons in the bunch.
To reduce the uncertainty in this measurement the number of electrons can be varied by adjusting the power of the red excitation laser.
The calibration was found to be 34.3 counts per electron.

This process was performed with the \gls{mcp} voltage at \unit[1.7]{kV} and the phosphor voltage at \unit[4.0]{kV} and all the measurement shown in this chapter use those parameters.

\subsubsection{Source Size}
Another required parameter is the size of the source which is required to determine the expected emittance using Equation~\ref{equation:excess_energy_emittance}.
The transverse source size is the same size as the excitation laser as it passed through the \gls{mot}.
This can be determined by intercepting the excitation laser with a mirror and directing the beam onto a camera placed the same distance away from the intercepting mirror as the location of the \gls{mot}.
Knowing the size of pixels for the camera allows for an image of the beam to be determined.
The source size was determined to be \unit[450.8]{$\muup$ m} in the vertical direction and \unit[690.6]{$\muup$ m} in the horizontal direction.
For simplicity the calculations in the following section have used the average of these two measurements.

\subsection{Two-Dimensional Pepperpots}
The frequency of the ionisation laser can to tuned to control the emittance of electron bunches as it determines the excess energy of bunches.
By varying the wavelength of the ionisation laser and measuring the emittance of the electron bunches using the two dimensional pepperpot allows for testing of the emittance measurement system and analysis as the results can be compared to the theory described by Equation~\ref{equation:excess_energy_emittance}.
The results from this test can be seen in Figure~\ref{figure:emittance_vs_theory} and the results are well matched to the theory and previous measurements of the emittance of this \gls{caes}~\cite{mcculloch_high-coherence_2013}.

\begin{figure}
    \center
    \input{part2/Figs/emittance_vs_theory.pgf}
    \caption{Emittance of electron bunches produced by the \gls{caes} (blue) compared to theoretical predictions (red), see Equation~\ref{equation:excess_energy_emittance}, and the results of analysis of simulation (green) as the excess energy is varied.}
    \label{figure:emittance_vs_theory}
    % Data and code located in 2017.06.06, Analyse.py
\end{figure}


\subsection{Streaked One-Dimensional Pepperpots}\label{section:streaked_pepperpot_results}
Shown in Figure~\ref{figure:streaks} are examples of time-resolved brightness measurement from streaked pepperpot measurements.
The measurements were conducted in the `slow' and `fast' modes previously discussed.
Both measurements were constructed from 1000 shot registered averages.
The wavelength of the blue ionisation laser was \unit[487.2]{nm} for the slow streak and \unit[475.9]{nm} for the fast streak which corresponds to \unit[-42.67]{meV} and \unit[17.00]{meV} excess energy respectively.
The wavelengths were carefully chosen to demonstrate streaking in the fast and slow modes.
As has been discussed a number of metrics can be extracted from the measurements each with temporal resolution.

\begin{figure}
    \center
    \input{part2/Figs/streaks.pgf}
    \caption{Long (left) and short (right) duration electron bunch streaked pepperpot measurements showing, from top to bottom, the false-colour streak image, full-beam current, normalised \gls{rms} emittance, and normalised brightness. The dotted black lines indicate the start of the electron bunches. The red dotted lines in the emittance measurement indicate the expected emittance from the simulations discussed in Section~\ref{section:pepperpot_simulation}}
    \label{figure:streaks}
\end{figure}

\subsubsection{Measurement Resolution}
The temporal resolution of these measurements in dictated by a number of factors, the finite \gls{psf} of the detector, the gradient or `slew' of the deflector voltages and the size of the beamlets on the detector.
The \gls{ccd} camera and lens used to take images of the detector is assumed to have a resolution much better than the point spread function of the phosphor screen.

The \gls{psf} of the \gls{mcp} and phosphor screen is approximately Gaussian with a standard deviation of \unit[35]{$\muup$m} and is measured by examining single electron events on the detector~\cite{rory_thesis}.
The streak calibration images (such as Figure~\ref{figure:example_calibration}) can be used as a simple measure for the size of the detected beamlets, which are a convolution of the beamlets size at the detector and the \gls{psf} of the detector.
The detected beamlets tend to have a size with an \gls{rms} around \unit[183]{$\muup$m} although this does vary with the emittance of the beam.
The majority of the signal from an electron is therefore contained within an area of four times the standard deviation or \unit[732]{$\muup$m} and thus the slow and fast streaks shown in Figure~\ref{figure:streaks} can be sliced into 27 and 18 temporal slices which correspond to time resolutions of \unit[524]{ns} and \unit[247]{ps} respectively.

The temporal resolution can be enhanced by careful optimisation of the streak on the detector.
Ensuring that the streak takes up the maximum available extent on the detector minimises the effect of the \gls{psf} on the temporal resolution with the downside that signal is now spread over a wider area thus reducing the \gls{snr}.
Another method to increase temporal resolution is to increase the temporal gradient of the electric field generated by the deflectors.

\subsection{Registration}\label{section:emittance_registration}
Due to the instability in the beam path (see Section~\ref{section:stability}) it is necessary to `register' the sets of images captured for measurements.
The registration consisted of convolving each image with a reference image, recording the maximum value of the convolution and then aligning all the images using the convolution maxima.
The reference image usually consists of either just the first image in the set or the average image of the entire set.
The registration process can also be performed iteratively where the reference image become the output of the previous iteration.

This works well for high-signal image sets but does not work as well for lower signal sets such as two-dimensional pepperpots or one-dimensional pepperpot streaks.
Lower signal data requires more care and in some cases cannot be registered.
One of the registration errors that occurs with pepperpot data is `slipping' where the brightest beamlets in the reference image and the image being aligned are not the same and the image is thus aligned incorrectly.
This error can be evaded by applying a limit to how far the convolution maxima of an image can change from shot to shot, generally the limit should be less than the distance between beamlets.
This allows slow drift of the beam path to be dealt with while preventing slipping.
Any changes to the beam path between shots with a magnitude greater than the registration limit will result in slipping while the limit is applied but may be catered for if it is not enforced, as sudden jumps are rare this is rarely an issue and often causes more disruptive and blatant issues.

Slipped, and therefore failed, pepperpot registrations were easy to identify since the number of beamlets was known and slipped errors results in extra beamlets appearing the the registered image.
While registering the pepperpots the best results were provided with around 3 iterations and limits on the shot-to-shot drift less than distance between the pepperpots.
An example of a slipped registration is shown in Figure~\ref{figure:registration_examples}.

\begin{figure}
    \center
    \input{part2/Figs/registration_examples.pgf}
    \caption{Single-Shot is a single image from a streaked pepperpot data set of 1000 images. Average is the simple of all 1000 images. Slipped is an attempt at registration that only looks for the maximum value of the convolution with no limit on shot-to-shot variation, there is an additional, faint beamlet visible at the top of the image. Registration is a successful registration where a shot-to-shot limit to drift of 5 pixels was enforced. Below each image is the row sum of image. All the images are independently log scaled.}
    \label{figure:registration_examples}
    % Data and code in 2017.07.24 plot_registration_examples.py
\end{figure}

{\color{red} I'm still not happy with this example of slipping. I should look for a better one. I may have to engineer one.}

{\color{red}This should also be probably moved to a more general chapter with a rewording and just a reference to that section here.}

\subsection{Electron Flux}
The current electron flux of the \gls{caes} is not sufficient to perform the streaked emittance measurement in a single-shot and in some scenarios (such as ionisation pathways with poor coupling) the flux is so low that registration of measurements cannot be performed making those measurements impossible.

At the core of the image analysis required for this measurement is the determination of the amplitude, mean and standard deviation of the peaks of the pepperpot beamlets.
In order to roughly estimate the number of electrons required in a beamlet to determine the mean and standard deviation to 95\% accuracy some simulations were run.
These simulations randomly draw $N$ values from a normal distribution and then compare the sample's mean, $\bar{x_s}$ and standard deviation, $\sigma_s$ to those of the normal distribution, $\bar{x}$ and $\sigma$, with the error functions
\begin{align}
E_{\bar{x}} &= \frac{\left|\bar{x} - \bar{x_s}\right|}{\sigma}\label{equation:error_mean}\\
E_{\sigma} &= \frac{\left|\sigma - \sigma_s\right|}{\sigma}.\label{equation:error_std}
\end{align}
The simulation is repeated multiple times for a range of values of $N$.
While not rigorous Equations~\ref{equation:error_mean} and \ref{equation:error_std} give an estimate of the accuracy possible with a given number of electrons when determining beamlet parameters.
The results of these simulations are shown in Figure\ref{figure:gaussian_simulation}.
In order to reduce the value of the error functions below 0.05 then 253 electrons are required for the mean and 128 for the standard deviation.

\begin{figure}
    \center
    \input{part2/Figs/gaussian_sim.pgf}
    \caption{Results from a simulation of the accuracy of sample mean and standard deviation given the size of the sample. For each value of sample size the simulation are repeated 100,000 times. The red dashed line indicates an error value of 0.05 and it intersects the mean (blue) at 253 and the standard deviation (STD, green) at 128. Error is defined in Equations~\ref{equation:error_mean} and \ref{equation:error_std}.}
    \label{figure:gaussian_simulation}
    % Code can be found in Code/Electrons/Simulation/MinimumSignal.py
\end{figure}

Estimating the required number of particles for a single-shot streaked emittance measurement is impossible without knowing a number of the parameters involved in a particular measurement scenario.
To simplify matters here the parameters are assumed to be the same as those used in the fast mode streaks described in Section~\ref{section:streaked_pepperpot_results}.
With a measurement with 200 points in time and 7 beamlets each requiring a minimum of 253 electrons would require 354,000 electrons after the pepperpot mask and approximately 10 million electrons in the full beam.
This estimate is somewhat generous as it assumes all the beamlets have the same intensity across the pepperpot and throughout the streak.
Certain photocathode sources are able to achieve electron counts of order $10^8$ electrons per bunch and thus these techniques could performed in a single shot and thus prove useful for beam diagnostics for these sources~\cite{li_note:_2010,musumeci_high_2010}.

{\color{red}Extrapolate properly taking beam spatial and temporal profile into account.

Consider mentioning that just multiplying the total number of trons times the number of shots gets the same result.... much easier, more intuitive way of calculating it.}
% fast streak length in 256-24=232pixels


{\color{red}I'm not happy with my error function for the mean... Doing it properly looks complicated. :/}

\section{Conclusion}
This chapter has presented an implementation of time-resolved brightness measurements using streaked pepperpots at the University of Melbourne \gls{caes}.
This technique has promise for use in a wide range of charged particle beam sources and is widely applicable to a range of scenarios.
With a sufficiently high-current source, such as photocathode electron sources, this technique can also be used to perform measurements in a single-shot.
Time-resolved brightness measurements have the potential to provide information on the behaviour of charged particle sources allowing for a better understanding of the physics involved and improvement of the apparatus involved.

{\color{red}
\section{To Do}
\begin{itemize}
    \item finish simulation section
    \item update everything with paper discoveries
    \item change `slow' and `fast' to long and short duration
    \item redo minimum flux section
\end{itemize}
}